<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Progress - 5R Associates</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .breadcrumb {
            display: flex;
            gap: 10px;
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .request-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .request-info h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-item label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-PAYMENT {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-IN_PROGRESS {
            background: #74b9ff;
            color: #0984e3;
        }

        .status-COMPLETED {
            background: #55efc4;
            color: #00b894;
        }

        .timeline {
            position: relative;
            padding-left: 50px;
            margin-top: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }

        .timeline-item {
            position: relative;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -38px;
            top: 30px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3498db;
            border: 4px solid white;
            box-shadow: 0 0 0 2px #3498db;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .timeline-date {
            color: #3498db;
            font-weight: 600;
            font-size: 14px;
        }

        .timeline-description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .timeline-media {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .media-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .media-item:hover {
            transform: scale(1.02);
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }

        .media-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Modal for full-screen media */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .modal-content img,
        .modal-content video {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="/frontend/pages/user/dashboard.html">Dashboard</a>
            <span>/</span>
            <span>Work Progress</span>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <h1>Work Progress Updates</h1>
            <p>Track the progress of your construction project</p>
        </div>

        <!-- Request Information -->
        <div class="request-info" id="request-info">
            <div class="loading">Loading request information...</div>
        </div>

        <!-- Progress Timeline -->
        <div class="timeline" id="progress-timeline">
            <div class="loading">Loading progress updates...</div>
        </div>
    </div>

    <!-- Media Modal -->
    <div class="modal" id="media-modal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content" id="modal-content"></div>
    </div>

    <script type="module">
        import { requestAPI, progressAPI } from '/js/api.js';

        // Get request ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const requestId = urlParams.get('requestId');

        if (!requestId) {
            showError('No request ID provided');
        } else {
            loadRequestInfo(requestId);
            loadProgress(requestId);
        }

        // Load request information
        async function loadRequestInfo(requestId) {
            const container = document.getElementById('request-info');

            try {
                const response = await requestAPI.getById(requestId);
                const request = response.data;

                if (!request) {
                    throw new Error('Request not found');
                }

                container.innerHTML = `
                    <h2>${request.requestId}</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Service</label>
                            <div class="value">${request.service?.name || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <label>Status</label>
                            <div class="value">
                                <span class="status-badge status-${request.status}">${request.status}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Project Location</label>
                            <div class="value">${request.location || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <label>Start Date</label>
                            <div class="value">${new Date(request.createdAt).toLocaleDateString('en-IN')}</div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading request:', error);
                container.innerHTML = `
                    <div class="alert alert-error">
                        Failed to load request information
                    </div>
                `;
            }
        }

        // Load progress updates
        async function loadProgress(requestId) {
            const timeline = document.getElementById('progress-timeline');

            try {
                const response = await progressAPI.getByRequestId(requestId);
                const progressList = response.data || [];

                // Also load advance payments for this request
                try {
                    const advanceRes = await fetch(`http://localhost:5000/api/advance-payments/request/${requestId}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    });
                    if (advanceRes.ok) {
                        const advanceData = await advanceRes.json();
                        displayAdvancePayments(advanceData.data || []);
                    }
                } catch (e) {
                    console.log('No advance payments yet');
                }

                if (progressList.length === 0) {
                    timeline.innerHTML = `
                        <div class="empty-state">
                            <i>üìã</i>
                            <h3>No Progress Updates Yet</h3>
                            <p>Work progress will appear here once the admin uploads updates</p>
                        </div>
                    `;
                    return;
                }

                // Sort by date (newest first)
                progressList.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                timeline.innerHTML = '';
                progressList.forEach((progress, index) => {
                    const item = createTimelineItem(progress, index === 0);
                    timeline.appendChild(item);
                });

            } catch (error) {
                console.error('Error loading progress:', error);
                timeline.innerHTML = `
                    <div class="alert alert-error">
                        Failed to load progress updates
                    </div>
                `;
            }
        }

        // Display advance payments for user
        function displayAdvancePayments(advances) {
            if (!advances || advances.length === 0) return;

            const timeline = document.getElementById('progress-timeline');

            // Create advance payment info section
            const advanceSection = document.createElement('div');
            advanceSection.style.cssText = `
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 4px;
            `;

            let advanceHTML = '<h4 style="margin-top: 0; color: #856404;">üí∞ Advance Payments</h4>';

            advances.forEach(adv => {
                const status = adv.status === 'PAID' ? '‚úÖ' : adv.status === 'PENDING' ? '‚è≥' : 'üìã';
                advanceHTML += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                        <div><strong>Advance: ‚Çπ${adv.advanceAmount}</strong> <span>${status} ${adv.status}</span></div>
                        <div style="font-size: 12px; color: #666;">Stage: ${adv.stage}</div>
                        <div style="font-size: 12px; color: #666;">Requested: ${new Date(adv.requestedAt).toLocaleDateString('en-IN')}</div>
                    </div>
                `;
            });

            advanceSection.innerHTML = advanceHTML;
            timeline.insertBefore(advanceSection, timeline.firstChild);
        }

        // Create timeline item
        function createTimelineItem(progress, isLatest) {
            const div = document.createElement('div');
            div.className = 'timeline-item';

            const date = new Date(progress.createdAt).toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            const time = new Date(progress.createdAt).toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const hasMedia = (progress.photos && progress.photos.length > 0) || (progress.videos && progress.videos.length > 0);

            div.innerHTML = `
                <div class="timeline-header">
                    <div class="timeline-date">
                        ${date} at ${time}
                        ${isLatest ? '<span style="color: #27ae60; margin-left: 10px;">‚óè Latest Update</span>' : ''}
                    </div>
                </div>
                <h3 style="color: #2c3e50; margin-bottom: 10px;">${progress.title || 'Progress Update'}</h3>
                ${progress.description ? `
                    <div class="timeline-description">
                        ${progress.description}
                    </div>
                ` : ''}
                <div style="margin: 10px 0;">
                    <strong>Completion: ${progress.completionPercent}%</strong>
                    <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 5px;">
                        <div style="background: #3498db; height: 100%; width: ${progress.completionPercent}%; border-radius: 4px;"></div>
                    </div>
                </div>
                ${hasMedia ? `
                    <div class="timeline-media">
                        ${progress.photos && progress.photos.map(photo => `
                            <div class="media-item" onclick="openMedia('${photo}', 'image')">
                                <img src="${photo}" alt="Progress image">
                                <div class="media-label">üì∑ Photo</div>
                            </div>
                        `).join('')}
                        ${progress.videos && progress.videos.map(video => `
                            <div class="media-item" onclick="openMedia('${video}', 'video')">
                                <video src="${video}"></video>
                                <div class="media-label">üé• Video</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            return div;
        }

        // Open media in modal
        window.openMedia = (url, type) => {
            const modal = document.getElementById('media-modal');
            const content = document.getElementById('modal-content');

            if (type === 'image') {
                content.innerHTML = `<img src="${url}" alt="Progress image">`;
            } else {
                content.innerHTML = `<video src="${url}" controls autoplay></video>`;
            }

            modal.classList.add('active');
        };

        // Close modal
        window.closeModal = () => {
            const modal = document.getElementById('media-modal');
            modal.classList.remove('active');
            document.getElementById('modal-content').innerHTML = '';
        };

        // Close modal on click outside
        document.getElementById('media-modal').addEventListener('click', (e) => {
            if (e.target.id === 'media-modal') {
                closeModal();
            }
        });

        // Show error
        function showError(message) {
            document.querySelector('.container').innerHTML = `
                <div class="alert alert-error">
                    ${message}
                </div>
                <p><a href="/frontend/pages/user/dashboard.html">Go to Dashboard</a></p>
            `;
        }
    </script>
</body>

</html>